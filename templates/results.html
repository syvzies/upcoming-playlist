<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upcoming Playlist Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa;
        }
        .content-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .flash-messages {
            margin-bottom: 1rem;
        }
        .artist-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }
        .badge {
            font-size: 0.9em;
        }
        .track-item {
            margin-left: 1.5rem;
            font-style: italic;
            color: #6c757d;
        }
        .spotify-warning {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
        }
        .spotify-auth-prompt {
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 5px;
            background-color: #cce5ff;
            border: 1px solid #b8daff;
            text-align: center;
        }
        .source-info {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="content-container">
            <div class="header">
                <h1 class="display-5">Artist Results</h1>
                <p class="lead">Found {{ artists|length }} unique artists from your venue</p>
            </div>
            
            <!-- Flash Messages -->
            <div class="flash-messages">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category if category != 'error' else 'danger' }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>
            
            <!-- Source Information -->
            <div class="source-info">
                <strong>Source:</strong> {{ url }}
            </div>
            
            <!-- Spotify Authentication Prompt (if configured but not authenticated) -->
            {% if spotify_configured and not spotify_authenticated %}
                <div class="spotify-auth-prompt">
                    <h5>Connect to Spotify</h5>
                    <p>To preview and add tracks to your playlist, please connect your Spotify account.</p>
                    <a href="{{ spotify_auth_url }}" class="btn btn-primary">Connect with Spotify</a>
                </div>
            {% endif %}
            
            <!-- Spotify Credentials Warning (if not configured) -->
            {% if not spotify_configured %}
                <div class="spotify-warning">
                    <h5>⚠️ Spotify credentials not configured</h5>
                    <p class="mb-0">To enable Spotify integration, set the following environment variables:</p>
                    <ul>
                        <li>SPOTIFY_CLIENT_ID</li>
                        <li>SPOTIFY_CLIENT_SECRET</li>
                        <li>SPOTIFY_PLAYLIST_ID</li>
                        <li>SPOTIFY_REDIRECT_URI (optional, defaults to http://localhost:5000/callback)</li>
                    </ul>
                    <p class="mb-0">See the <a href="https://developer.spotify.com/dashboard/" target="_blank">Spotify Developer Dashboard</a> to create your credentials.</p>
                </div>
            {% endif %}
            
            <!-- Artist List -->
            <h4>Artists Found <span class="badge bg-primary">{{ artists|length }}</span></h4>
            <div class="artist-list">
                <ul class="list-group">
                    {% for artist in artists %}
                        <li class="list-group-item">{{ artist }}</li>
                    {% endfor %}
                </ul>
            </div>
            
            {% if spotify_authenticated and url %}
                <div class="d-grid gap-2 mt-3 mb-4">
                    {% if not preview_results %}
                        <a href="{{ url_for('results') }}" class="btn btn-primary" onclick="showLoading('Searching for tracks...')">Search for Tracks</a>
                    {% else %}
                        <a href="{{ url_for('results', reset=1) }}" class="btn btn-outline-secondary" onclick="showLoading('Searching for tracks...')">Search Again</a>
                    {% endif %}
                </div>
            {% endif %}
            
            <!-- Preview Results (if Spotify is authenticated) -->
            {% if spotify_authenticated and preview_results %}
                <h4>Spotify Tracks Preview <span class="badge bg-success">{{ preview_results|length }} artists</span></h4>
                <div class="artist-list">
                    <ul class="list-group">
                        {% for result in preview_results %}
                            <li class="list-group-item">
                                <strong>{{ result.name }}</strong>
                                {% for track in result.tracks %}
                                    <div class="track-item">{{ track }}</div>
                                {% endfor %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <!-- Add to Playlist Form -->
                <form id="addTracksForm" method="POST" action="{{ url_for('add_to_playlist') }}" class="mb-4">
                    <div class="mb-3">
                        <label for="playlist_id" class="form-label">Select Playlist</label>
                        <select class="form-select" id="playlist_id" name="playlist_id" required>
                            <option value="" disabled selected>Choose a playlist...</option>
                            {% for playlist in user_playlists %}
                                <option value="{{ playlist.id }}">{{ playlist.name }} ({{ playlist.tracks_total }} tracks)</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Select the playlist where you want to add these tracks
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-grid">
                            {% set track_count = 0 %}
                            {% for result in preview_results %}
                                {% if result.track_uris is defined and result.track_uris %}
                                    {% set track_count = track_count + result.track_uris|length %}
                                {% endif %}
                            {% endfor %}
                            <button type="submit" class="btn btn-success btn-lg">
                                Add {{ track_count }} Tracks to Selected Playlist
                            </button>
                            <div class="form-text text-center mt-1">
                                Found {{ preview_results|length }} artists with tracks
                            </div>
                        </div>
                    </div>
                    
                    <!-- Clear Playlist Button -->
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-danger w-100" 
                                data-bs-toggle="modal" data-bs-target="#clearPlaylistModal">
                            Clear Selected Playlist
                        </button>
                    </div>
                </form>
            {% endif %}
            
            <!-- Playlist Results (if tracks were added) -->
            {% if playlist_results %}
                <h4>Tracks Added to Playlist <span class="badge bg-success">{{ playlist_results|length }} artists</span></h4>
                <div class="artist-list">
                    <ul class="list-group">
                        {% for result in playlist_results %}
                            <li class="list-group-item">
                                <strong>{{ result.name }}</strong>
                                {% for track in result.tracks %}
                                    <div class="track-item">{{ track }}</div>
                                {% endfor %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            <!-- Action Buttons -->
            <div class="d-grid gap-2 mt-4">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Start Over</a>
                {% if spotify_authenticated %}
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">Disconnect Spotify</a>
                {% endif %}
            </div>
            
            <!-- Clear Playlist Confirmation Modal -->
            {% if spotify_authenticated and user_playlists %}
            <div class="modal fade" id="clearPlaylistModal" tabindex="-1" aria-labelledby="clearPlaylistModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="clearPlaylistModalLabel">Confirm Playlist Clearing</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-danger">
                                <strong>Warning:</strong> This will remove ALL tracks from the selected playlist. 
                                This action cannot be undone.
                            </p>
                            <form id="clearPlaylistForm" method="POST" action="{{ url_for('clear_playlist_route') }}">
                                <div class="mb-3">
                                    <label for="modal_playlist_id" class="form-label">Select Playlist to Clear</label>
                                    <select class="form-select" id="modal_playlist_id" name="playlist_id" required>
                                        <option value="" disabled selected>Choose a playlist...</option>
                                        {% for playlist in user_playlists %}
                                            <option value="{{ playlist.id }}">{{ playlist.name }} ({{ playlist.tracks_total }} tracks)</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" onclick="showLoading('Clearing playlist...'); document.getElementById('clearPlaylistForm').submit();">
                                Clear All Tracks
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Loading Overlay - Initially invisible with Bootstrap d-none -->
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-none align-items-center justify-content-center" style="z-index: 9999;">
        <div class="text-center text-white">
            <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 id="loadingMessage">Working with Spotify...</h5>
        </div>
    </div>

    <!-- Bootstrap JS (required for modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script to sync playlist selection and handle loading states -->
    <script>
        // Initialize the loading system
        var loadingInitialized = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            // When main form playlist selector changes, update the modal
            const mainPlaylistSelect = document.getElementById('playlist_id');
            const modalPlaylistSelect = document.getElementById('modal_playlist_id');
            const loadingMessage = document.getElementById('loadingMessage');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const addTracksForm = document.getElementById('addTracksForm');
            const clearPlaylistForm = document.getElementById('clearPlaylistForm');
            
            // Sync playlist selectors
            if (mainPlaylistSelect && modalPlaylistSelect) {
                mainPlaylistSelect.addEventListener('change', function() {
                    modalPlaylistSelect.value = mainPlaylistSelect.value;
                });
                
                // Initially set modal value to match main form
                if (mainPlaylistSelect.value) {
                    modalPlaylistSelect.value = mainPlaylistSelect.value;
                }
            }
            
            // Show loading overlay when forms are submitted
            if (addTracksForm && loadingOverlay && loadingMessage) {
                addTracksForm.addEventListener('submit', function() {
                    loadingMessage.textContent = 'Adding tracks to Spotify playlist...';
                    loadingOverlay.classList.remove('d-none');
                    loadingOverlay.classList.add('d-flex');
                });
            }
            
            if (clearPlaylistForm && loadingOverlay && loadingMessage) {
                clearPlaylistForm.addEventListener('submit', function() {
                    loadingMessage.textContent = 'Clearing playlist...';
                    loadingOverlay.classList.remove('d-none');
                    loadingOverlay.classList.add('d-flex');
                });
            }
        });
        
        // Only enable the interactive elements after page is fully loaded
        window.addEventListener('load', function() {
            loadingInitialized = true;
        });
        
        // Helper function for links and buttons - only works after page load
        function showLoading(message) {
            if (loadingInitialized) {
                var loadingMessage = document.getElementById('loadingMessage');
                var loadingOverlay = document.getElementById('loadingOverlay');
                
                if (loadingMessage && loadingOverlay) {
                    loadingMessage.textContent = message || 'Working with Spotify...';
                    loadingOverlay.classList.remove('d-none');
                    loadingOverlay.classList.add('d-flex');
                }
            }
        }
    </script>
</body>
</html>